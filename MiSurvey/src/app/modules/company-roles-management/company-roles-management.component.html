<div *ngIf="userPermissions$ | async as permissions">
  <div class="d-flex justify-content-start">
    <button
      *ngIf="permissions.CanAdd"
      class="btn-action me-2"
      [cModalToggle]="addRoleModal.id"
    >
      Create a new role
    </button>
    <button *ngIf="permissions.CanExport" class="btn-action">
      Export Data
    </button>
  </div>
  <div style="flex: 1" *ngIf="!permissions.CanView">
    <p>You not has permissions to view anything!</p>
  </div>
  <div *ngIf="permissions.CanView" class="input-group mb-3">
    <div class="input-group-prepend">
      <c-dropdown>
        <button class="btn-management" cButton cDropdownToggle>Filter</button>
        <ul cDropdownMenu>
          <li>
            <button cDropdownItem>Role Name</button>
          </li>
          <li>
            <button cDropdownItem>Description</button>
          </li>
          <li>
            <button cDropdownItem>Created At</button>
          </li>
        </ul>
      </c-dropdown>
    </div>
    <form
      class="form-search-management"
      onsubmit="event.preventDefault();"
      role="search"
    >
      <input
        class="input-search-management"
        id="search"
        type="search"
        placeholder="Search..."
        autofocus
        required
      />
    </form>

    <c-button-group class="group-button-management" role="group">
      <button cButton>Search</button>
      <button class="btn-border-right btn-borderStyle-left" cButton>
        Refresh
      </button>
    </c-button-group>
  </div>

  <table
    class="table"
    [hover]="true"
    [responsive]="true"
    [striped]="true"
    cTable
    class="mb-0 border"
    *ngIf="permissions.CanView"
  >
    <thead cTableColor="default">
      <tr>
        <th scope="col">NO</th>
        <th scope="col">Role Name</th>
        <th scope="col">Description</th>
        <th scope="col">Created At</th>
      </tr>
    </thead>
    <tbody>
      <!-- Loop through the users array using the *ngFor directive -->
      <tr *ngFor="let role of roles$ | async; let i = index">
        <td scope="row">{{ i + 1 }}</td>
        <td>{{ role.CompanyRoleName }}</td>
        <td>{{ role.CompanyRoleDescription }}</td>
        <td>{{ role.CreatedAt }}</td>
        <td>
          <c-dropdown class="d-flex justify-content-center">
            <span class="action-management" cButton cDropdownToggle> </span>
            <ul cDropdownMenu>
              <li>
                <button
                  *ngIf="permissions.CanViewData"
                  cDropdownItem
                  (click)="viewRole(role.CompanyRoleID)"
                >
                  View
                </button>
              </li>
              <li>
                <button
                  *ngIf="permissions.CanUpdate"
                  cDropdownItem
                  (click)="openEditModal(role.CompanyRoleID)"
                >
                  Edit
                </button>
              </li>
              <li>
                <button
                  *ngIf="permissions.CanDelete"
                  cDropdownItem
                  [cModalToggle]="deleteRoleModal.id"
                >
                  Delete
                </button>
              </li>
            </ul>
          </c-dropdown>
        </td>
      </tr>
    </tbody>
  </table>

  <c-modal size="lg" [scrollable]="true" alignment="center" #addRoleModal id="addRoleModal">
    <c-modal-header>
      <h5 cModalTitle>Add New Role</h5>
      <button class="btn-close" type="button" cButtonClose [cModalToggle]="addRoleModal.id"></button>
    </c-modal-header>
    <c-modal-body>
      <form [formGroup]="roleForm" (ngSubmit)="submitRole()">
        <div class="mb-3" formGroupName="roleData">
          <label for="roleName">Role Name</label>
          <input type="text" class="form-control" id="roleName" formControlName="CompanyRoleName" placeholder="Role Name" />
          <label for="roleDescription">Role Description</label>
          <input type="text" class="form-control" id="roleDescription" formControlName="CompanyRoleDescription" placeholder="Role Description" />
        </div>
        <div *ngIf="modules$ | async as modules">
          <table class="table">
            <thead>
              <tr>
                <th>Module</th>
                <th>Can View</th>
                <th>Can Add</th>
                <th>Can Update</th>
                <th>Can Delete</th>
                <th>Can Export</th>
                <th>Can View Data</th>
              </tr>
            </thead>
            <tbody formArrayName="permissionsData">
              <tr *ngFor="let permissionControl of permissionsData.controls; let i = index" [formGroupName]="i">
                <td>{{ modules[i].name }}</td>
                <td><input type="checkbox" formControlName="CanView" /></td>
                <td><input type="checkbox" formControlName="CanAdd" /></td>
                <td><input type="checkbox" formControlName="CanUpdate" /></td>
                <td><input type="checkbox" formControlName="CanDelete" /></td>
                <td><input type="checkbox" formControlName="CanExport" /></td>
                <td><input type="checkbox" formControlName="CanViewData" /></td>
              </tr>
            </tbody>
          </table>
        </div>
      </form>
    </c-modal-body>
    <c-modal-footer>
      <button type="button" cButton [cModalToggle]="addRoleModal.id">Close</button>
      <button type="button" cButton (click)="submitRole()">Save Role</button>
    </c-modal-footer>
  </c-modal>

  <c-modal
    size="lg"
    [scrollable]="true"
    alignment="center"
    #deleteRoleModal
    id="deleteRoleModal"
    scrollable
  >
    <c-modal-header>
      <h5 cModalTitle>Confirm User Deletion</h5>
      <button
        class="btn-close"
        [cModalToggle]="deleteRoleModal.id"
        cButtonClose
      ></button>
    </c-modal-header>
    <c-modal-body>
      Are you sure you want to delete this user? This action cannot be undone.
    </c-modal-body>
    <c-modal-footer>
      <button [cModalToggle]="deleteRoleModal.id" cButton color="secondary">
        Cancel
      </button>
      <button cButton color="danger">Delete</button>
    </c-modal-footer>
  </c-modal>
</div>

<c-modal size="lg" [scrollable]="true" alignment="center" #editRoleModal id="editRoleModal">
  <c-modal-header>
    <h5 cModalTitle>Edit Role</h5>
    <button class="btn-close" type="button" cButtonClose [cModalToggle]="editRoleModal.id"></button>
  </c-modal-header>
  <c-modal-body>
    <form [formGroup]="roleFormEdit">
      <div formGroupName="roleData" class="mb-3">
        <label for="roleName">Role Name</label>
        <input type="text" class="form-control" id="roleName" formControlName="CompanyRoleName" placeholder="Role Name" required />
        <label for="roleDescription">Role Description</label>
        <input type="text" class="form-control" id="roleDescription" formControlName="CompanyRoleDescription" placeholder="Role Description" />
      </div>
      <div *ngIf="modules$ | async as modules">
        <table class="table permissions-table">
          <thead>
            <tr>
              <th>Module</th>
              <th>Can View</th>
              <th>Can Add</th>
              <th>Can Update</th>
              <th>Can Delete</th>
              <th>Can Export</th>
              <th>Can View Data</th>
            </tr>
          </thead>
          <tbody formArrayName="permissionsDataEdit">
            <tr *ngFor="let permissionControl of permissionsDataEdit.controls; let i = index" [formGroupName]="i">
              <td>{{ modules[i].name }}</td>
              <td><input type="checkbox" formControlName="CanView" /></td>
              <td><input type="checkbox" formControlName="CanAdd" /></td>
              <td><input type="checkbox" formControlName="CanUpdate" /></td>
              <td><input type="checkbox" formControlName="CanDelete" /></td>
              <td><input type="checkbox" formControlName="CanExport" /></td>
              <td><input type="checkbox" formControlName="CanViewData" /></td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>
  </c-modal-body>
  <c-modal-footer>
    <button type="button" cButton [cModalToggle]="editRoleModal.id">Close</button>
    <button type="button" cButton (click)="submitEditRole()">Update Role</button>
  </c-modal-footer>
</c-modal>
