<app-loading *ngIf="isLoading$ | async"></app-loading>
<div *ngIf="userPermissions$ | async as permissions">
  <div class="d-flex justify-content-start">
    <button
      *ngIf="permissions.CanAdd"
      class="btn-action me-2"
      [cModalToggle]="addUserModal.id"
    >
      Create a new user
    </button>
    <button *ngIf="permissions.CanExport" class="btn-action">
      Export Data
    </button>
  </div>
  <div style="flex: 1" *ngIf="!permissions.CanView">
    <p>You not has permissions to view anything!</p>
  </div>
  <div *ngIf="permissions.CanView" class="input-group mb-3">
    <div class="input-group-prepend">
      <c-dropdown>
        <button class="btn-management" cButton cDropdownToggle>Filter</button>
        <ul cDropdownMenu>
          <li>
            <button cDropdownItem>Name</button>
          </li>
          <li>
            <button cDropdownItem>Role</button>
          </li>
          <li>
            <button cDropdownItem>Active</button>
          </li>
        </ul>
      </c-dropdown>
    </div>
    <form
      class="form-search-management"
      onsubmit="event.preventDefault();"
      role="search"
    >
      <input
        class="input-search-management"
        id="search"
        type="search"
        placeholder="Search..."
        autofocus
        required
      />
    </form>

    <c-button-group class="group-button-management" role="group">
      <button cButton>Search</button>
      <button class="btn-border-right btn-borderStyle-left" cButton>
        Refresh
      </button>
    </c-button-group>
  </div>

  <table
    class="table"
    [hover]="true"
    [responsive]="true"
    [striped]="true"
    cTable
    class="mb-0 border"
    *ngIf="permissions.CanView"
  >
    <thead cTableColor="default">
      <tr>
        <th scope="col">NO</th>
        <th scope="col">Avatar</th>
        <th scope="col">Full Name</th>
        <th scope="col">Email</th>
        <th scope="col">Role</th>
        <th scope="col">Active</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Loop through the users array using the *ngFor directive -->
      <tr *ngFor="let user of users$ | async; let i = index">
        <td scope="row">{{ i + 1 }}</td>
        <td>
          <c-avatar
            size="md"
            [src]="user.UserAvatar || './assets/img/avt_default.png'"
            status="success"
          ></c-avatar>
        </td>

        <td>{{ user.FirstName }} {{ user.LastName }}</td>
        <td>{{ user.Email }}</td>
        <td>{{ user.UserRole }}</td>
        <td>{{ user.IsActive ? "Active" : "Inactive" }}</td>
        <td>
          <c-dropdown class="d-flex justify-content-center">
            <span class="action-management" cButton cDropdownToggle> </span>
            <ul cDropdownMenu>
              <li>
                <button
                  *ngIf="user.UserID !== undefined && permissions.CanViewData"
                  cDropdownItem
                  (click)="viewUser(user.UserID)"
                >
                  View
                </button>
              </li>
              <li>
                <button
                  *ngIf="user.UserID !== undefined && permissions.CanUpdate"
                  cDropdownItem
                  (click)="editUser(user.UserID)"
                >
                  Edit
                </button>
              </li>
              <li>
                <button
                  *ngIf="permissions.CanDelete"
                  cDropdownItem
                  [cModalToggle]="deleteUserModal.id"
                >
                  Delete
                </button>
              </li>
            </ul>
          </c-dropdown>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="pagination">
    <button
      class="pagination-button"
      (click)="onPageChangePrevious()"
      [disabled]="currentPage === '1'"
    >
      << Previous
    </button>
    <div *ngFor="let page of getPaginationRange(currentPage, totalPages); let i = index" class="page-item">
      <button *ngIf="page !== '...'" (click)="onPageChange(page)" [class.active]="currentPage === page.toString()">
        {{ page }}
      </button>
      <span *ngIf="page === '...'">{{ page }}</span>
    </div>
    <button
      class="pagination-button"
      (click)="onPageChangeNext()"
      [disabled]="currentPage === totalPages.toString()"
    >
      Next >>
    </button>
  </div>

  <!-- Modal -->

  <!-- View User Modal -->
  <c-modal
    size="lg"
    [scrollable]="true"
    alignment="center"
    #viewUserModal
    id="viewUserModal"
    scrollable
  >
    <c-modal-header>
      <h5 cModalTitle>View User Details</h5>
      <button
        class="btn-close"
        [cModalToggle]="viewUserModal.id"
        cButtonClose
      ></button>
    </c-modal-header>
    <c-modal-body>
      <div
        class="modal-content-grid"
        *ngIf="selectedUser$ | async as selectedUser"
      >
        <div class="user-details">
          <ng-container>
            <p>Username: {{ selectedUser.Username }}</p>
            <p>First Name: {{ selectedUser.FirstName }}</p>
            <p>Last Name: {{ selectedUser.LastName }}</p>
            <p>Email: {{ selectedUser.Email }}</p>
            <p>Role: {{ selectedUser.UserRole }}</p>
            <p>Gender: {{ selectedUser.Gender }}</p>
            <p>Phone Number: {{ selectedUser.PhoneNumber }}</p>
            <p>Active: {{ selectedUser.IsActive ? "Yes" : "No" }}</p>
          </ng-container>
        </div>
        <div class="date-details">
          <p>Created By: {{ selectedUser.CreatedBy || "N/A" }}</p>
          <p>Updated By: {{ selectedUser.UpdatedBy || "N/A" }}</p>
          <mat-form-field appearance="fill">
            <mat-label>Created At</mat-label>
            <input
              matInput
              [matDatepicker]="createdAtPicker"
              [value]="selectedUser.CreatedAt | date : 'yyyy-MM-dd'"
              disabled
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="createdAtPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #createdAtPicker disabled></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Last Login</mat-label>
            <input
              matInput
              [matDatepicker]="lastLoginPicker"
              [value]="selectedUser.LastLogin | date : 'yyyy-MM-dd'"
              disabled
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="lastLoginPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #lastLoginPicker disabled></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Updated At</mat-label>
            <input
              matInput
              [matDatepicker]="updatedAtPicker"
              [value]="selectedUser.UpdatedAt | date : 'yyyy-MM-dd'"
              disabled
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="updatedAtPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #updatedAtPicker disabled></mat-datepicker>
          </mat-form-field>
        </div>
      </div>
    </c-modal-body>
  </c-modal>

  <!-- Edit User Modal -->
  <c-modal
    size="lg"
    [scrollable]="true"
    alignment="center"
    #editUserModal
    id="editUserModal"
    scrollable
  >
    <c-modal-header>
      <h5 cModalTitle>Edit User Details</h5>
      <button
        class="btn-close"
        [cModalToggle]="editUserModal.id"
        cButtonClose
      ></button>
    </c-modal-header>
    <c-modal-body>
      <form [formGroup]="editUserFormGroup">
        <div class="mb-3">
          <label for="editUsername" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="editUsername"
            formControlName="Username"
            placeholder="Username"
          />
        </div>
        <div class="mb-3">
          <label for="editFirstName" class="form-label">First Name</label>
          <input
            type="text"
            class="form-control"
            id="editFirstName"
            formControlName="FirstName"
            placeholder="First Name"
          />
        </div>
        <div class="mb-3">
          <label for="editLastName" class="form-label">Last Name</label>
          <input
            type="text"
            class="form-control"
            id="editLastName"
            formControlName="LastName"
            placeholder="Last Name"
          />
        </div>
        <div class="mb-3">
          <label for="editEmail" class="form-label">Email</label>
          <input
            type="email"
            class="form-control"
            id="editEmail"
            formControlName="Email"
            placeholder="Email"
          />
        </div>
        <div class="mb-3">
          <label for="editGender" class="form-label">Gender</label>
          <input
            type="text"
            class="form-control"
            id="editGender"
            formControlName="Gender"
            placeholder="Gender"
          />
        </div>
        <div class="mb-3">
          <label for="editPhoneNumber" class="form-label">Phone Number</label>
          <input
            type="tel"
            class="form-control"
            id="editPhoneNumber"
            formControlName="PhoneNumber"
            placeholder="Phone Number"
          />
        </div>
        <div class="mb-3">
          <label for="editRole" class="form-label">Role</label>
          <select class="form-select" id="editRole" formControlName="UserRole">
            <option selected>Select Role</option>
            <option value="SuperAdmin">SuperAdmin</option>
            <option value="Admin">Admin</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editActive" class="form-label">Active</label>
          <select
            class="form-control"
            id="editActive"
            formControlName="IsActive"
          >
            <option [ngValue]="1">Yes</option>
            <option [ngValue]="0">No</option>
          </select>
        </div>

        <!-- Date Fields -->
        <div class="mb-3">
          <mat-form-field appearance="fill">
            <mat-label>Created At</mat-label>
            <input
              matInput
              [matDatepicker]="editCreatedAtPicker"
              formControlName="CreatedAt"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="editCreatedAtPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #editCreatedAtPicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="mb-3">
          <mat-form-field appearance="fill">
            <mat-label>Last Login</mat-label>
            <input
              matInput
              [matDatepicker]="editLastLoginPicker"
              formControlName="LastLogin"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="editLastLoginPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #editLastLoginPicker></mat-datepicker>
          </mat-form-field>
        </div>
      </form>
    </c-modal-body>
    <c-modal-footer>
      <button [cModalToggle]="editUserModal.id" cButton color="secondary">
        Cancel
      </button>
      <button cButton color="primary" (click)="saveChanges()">
        Save Changes
      </button>
    </c-modal-footer>
  </c-modal>

  <!-- Delete User Modal -->
  <c-modal
    size="lg"
    [scrollable]="true"
    alignment="center"
    #deleteUserModal
    id="deleteUserModal"
    scrollable
  >
    <c-modal-header>
      <h5 cModalTitle>Confirm User Deletion</h5>
      <button
        class="btn-close"
        [cModalToggle]="deleteUserModal.id"
        cButtonClose
      ></button>
    </c-modal-header>
    <c-modal-body>
      Are you sure you want to delete this user? This action cannot be undone.
    </c-modal-body>
    <c-modal-footer>
      <button [cModalToggle]="deleteUserModal.id" cButton color="secondary">
        Cancel
      </button>
      <button cButton color="danger">Delete</button>
    </c-modal-footer>
  </c-modal>

  <c-modal
    size="lg"
    [scrollable]="true"
    alignment="center"
    #addUserModal
    id="addUserModal"
  >
    <c-modal-header>
      <h5 cModalTitle>Add New User</h5>
      <button
        class="btn-close"
        type="button"
        cButtonClose
        [cModalToggle]="addUserModal.id"
      ></button>
    </c-modal-header>
    <c-modal-body>
      <form [formGroup]="addUserForm">
        <div class="mb-3">
          <label for="userName" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="userName"
            formControlName="Username"
            placeholder="Username"
          />
        </div>
        <div class="mb-3">
          <label for="userPassword" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="userPassword"
            formControlName="UserPassword"
            placeholder="Password"
          />
        </div>
        <div class="mb-3">
          <label for="firstName" class="form-label">First Name</label>
          <input
            type="text"
            class="form-control"
            id="firstName"
            formControlName="FirstName"
            placeholder="First Name"
          />
        </div>
        <div class="mb-3">
          <label for="lastName" class="form-label">Last Name</label>
          <input
            type="text"
            class="form-control"
            id="lastName"
            formControlName="LastName"
            placeholder="Last Name"
          />
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input
            type="email"
            class="form-control"
            id="email"
            formControlName="Email"
            placeholder="Email"
          />
        </div>
        <div class="mb-3">
          <label for="phoneNumber" class="form-label"
            >Phone Number (Optional)</label
          >
          <input
            type="tel"
            class="form-control"
            id="phoneNumber"
            formControlName="PhoneNumber"
            placeholder="Phone Number"
          />
        </div>
        <div class="mb-3">
          <label for="userRole" class="form-label">Role</label>
          <select class="form-select" id="userRole" formControlName="UserRole" [disabled]="currentUserRole === 'Admin' || currentUserRole === 'Supervisor'">
            <option value="SuperAdmin">SuperAdmin</option>
            <option value="Admin">Admin</option>
            <option value="Supervisor" [selected]="currentUserRole === 'Admin' || currentUserRole === 'Supervisor'">Supervisor</option>
          </select>
        </div>
        
        <div *ngIf="addUserForm.get('UserRole')?.value === 'Admin'">
          <form [formGroup]="companyInfoFormGroup">
            <div class="mb-3">
              <label for="companyName" class="form-label">Company Name</label>
              <input type="text" class="form-control" id="companyName" formControlName="CompanyName" placeholder="Company Name" />
            </div>
            <div class="mb-3">
              <label for="companyDomain" class="form-label">Company Domain (Optional)</label>
              <input type="text" class="form-control" id="companyDomain" formControlName="CompanyDomain" placeholder="Company Domain" />
            </div>
          </form>
        </div>
        <div class="mb-3">
          <label for="isActive" class="form-label">Active</label>
          <select class="form-select" id="isActive" formControlName="IsActive">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="gender" class="form-label">Gender (Optional)</label>
          <select class="form-select" id="gender" formControlName="Gender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
      </form>
    </c-modal-body>
    <c-modal-footer>
      <button type="button" cButton [cModalToggle]="addUserModal.id">
        Close
      </button>
      <button type="button" cButton (click)="createUser()">Save User</button>
    </c-modal-footer>
  </c-modal>
</div>
